name: Create Production Tag

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Production version (e.g., v1.0.0)'
        required: true
        type: string
      release_notes:
        description: 'Release notes (optional)'
        required: false
        type: string
        default: ''

jobs:
  create-prod-tag:
    name: Create Production Tag
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate version format
        run: |
          VERSION="${{ github.event.inputs.version }}"

          # Check if version starts with 'v'
          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Error: Version must follow semantic versioning format (e.g., v1.0.0)"
            echo "   Provided: $VERSION"
            exit 1
          fi

          echo "âœ… Version format is valid: $VERSION"

      - name: Check if tag already exists
        run: |
          VERSION="${{ github.event.inputs.version }}"

          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "âŒ Error: Tag $VERSION already exists"
            echo "   Existing tags:"
            git tag -l "v[0-9]*.[0-9]*.[0-9]*" --sort=-version:refname | head -5
            exit 1
          fi

          echo "âœ… Tag $VERSION does not exist yet"

      - name: Get changes since last production tag
        id: changes
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 --match="v[0-9]*.[0-9]*.[0-9]*" 2>/dev/null || echo "v0.1.0")
          echo "last_tag=$LAST_TAG" >> $GITHUB_OUTPUT

          echo "Changes since $LAST_TAG:"
          git log $LAST_TAG..HEAD --oneline --decorate

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create production tag
        run: |
          VERSION="${{ github.event.inputs.version }}"
          RELEASE_NOTES="${{ github.event.inputs.release_notes }}"
          LAST_TAG="${{ steps.changes.outputs.last_tag }}"

          # Build tag message
          TAG_MESSAGE="Production release $VERSION"

          if [ -n "$RELEASE_NOTES" ]; then
            TAG_MESSAGE="$TAG_MESSAGE

$RELEASE_NOTES"
          else
            TAG_MESSAGE="$TAG_MESSAGE

Changes since $LAST_TAG:
$(git log $LAST_TAG..HEAD --oneline --format='- %s' | head -10)"
          fi

          # Create annotated tag
          git tag -a "$VERSION" -m "$TAG_MESSAGE"

          echo "âœ… Created tag: $VERSION"

      - name: Push tag
        run: |
          VERSION="${{ github.event.inputs.version }}"
          git push origin "$VERSION"
          echo "âœ… Pushed tag: $VERSION"

      - name: Summary
        run: |
          VERSION="${{ github.event.inputs.version }}"
          echo "ðŸŽ‰ Production tag created successfully!"
          echo ""
          echo "Tag: $VERSION"
          echo "View: https://github.com/${{ github.repository }}/releases/tag/$VERSION"
          echo ""
          echo "Dashboard engineers can now use:"
          echo "  go get github.com/eukarya-inc/reearth-proto@$VERSION"
